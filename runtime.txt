# ğŸ¤– Module IA - DÃ©tection des Maladies de Tomates

[![Python](https://img.shields.io/badge/Python-3.9+-blue.svg)](https://www.python.org/)
[![TensorFlow](https://img.shields.io/badge/TensorFlow-2.15-orange.svg)](https://www.tensorflow.org/)
[![Flask](https://img.shields.io/badge/Flask-3.0-green.svg)](https://flask.palletsprojects.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

Module d'intelligence artificielle pour la dÃ©tection automatique des maladies des tomates via analyse d'images. Utilise TensorFlow/Keras avec MobileNetV2 pour classifier 10 conditions diffÃ©rentes avec recommandations de traitement.

---

## ğŸ“‹ Table des MatiÃ¨res

- [FonctionnalitÃ©s](#-fonctionnalitÃ©s)
- [Architecture](#ï¸-architecture)
- [PrÃ©requis](#-prÃ©requis)
- [Installation](#-installation)
- [Structure du Projet](#-structure-du-projet)
- [EntraÃ®nement du ModÃ¨le](#-entraÃ®nement-du-modÃ¨le)
- [API Flask](#-api-flask)
- [Classes DÃ©tectÃ©es](#-classes-dÃ©tectÃ©es)
- [DÃ©ploiement](#-dÃ©ploiement)
- [Utilisation](#-utilisation)
- [Tests](#-tests)
- [Troubleshooting](#-troubleshooting)
- [Contribution](#-contribution)
- [Licence](#-licence)

---

## âœ¨ FonctionnalitÃ©s

- âœ… **DÃ©tection de 10 conditions** : 9 maladies + plantes saines
- ğŸ§  **Transfer Learning** : MobileNetV2 prÃ©-entraÃ®nÃ© sur ImageNet
- ğŸ”„ **Augmentation de donnÃ©es** : Rotation, flip, zoom pour robustesse
- ğŸ“¡ **API REST Flask** : IntÃ©gration ESP32-CAM et backend Node.js
- ğŸ¯ **Analyse complÃ¨te** : Confiance, sÃ©vÃ©ritÃ©, recommandations
- ğŸ’¡ **Recommandations intelligentes** : Actions ciblÃ©es par maladie
- ğŸŒŠ **Gestion d'arrosage** : DÃ©termination automatique des besoins
- ğŸ“¤ **IntÃ©gration backend** : Envoi automatique des rÃ©sultats
- ğŸ—‘ï¸ **Traitement sans stockage** : Suppression auto des images
- ğŸ“Š **Mode DEMO** : Fonctionnement sans modÃ¨le pour tests
- ğŸ” **Analyse batch** : Support de plusieurs images simultanÃ©es

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ESP32-CAM   â”‚â”€â”€â”€â”€â–¶â”‚  Module IA      â”‚â”€â”€â”€â”€â–¶â”‚  Backend Node.js â”‚â”€â”€â”€â”€â–¶â”‚ MongoDB  â”‚
â”‚  (Photo)     â”‚     â”‚  Flask:5001     â”‚     â”‚  Express:5000    â”‚     â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                     RÃ©sultats + Recommandations
```

### ğŸ”„ Flux de Traitement

1. **Capture** : ESP32-CAM prend une photo de la feuille
2. **Envoi** : POST `/predict` avec `image` + `capteurId` + `userId`
3. **PrÃ©traitement** : Redimensionnement 224x224, normalisation RGB
4. **PrÃ©diction** : MobileNetV2 â†’ Classe + Niveau de confiance
5. **Enrichissement** : Calcul sÃ©vÃ©ritÃ©, recommandations, besoins arrosage
6. **Transmission** : Envoi rÃ©sultats au backend via API REST
7. **Nettoyage** : Suppression automatique de l'image de la mÃ©moire

---

## ğŸ“¦ PrÃ©requis

### SystÃ¨me
- **Python** : 3.9 - 3.11 (recommandÃ© : 3.11)
- **RAM** : 4 GB minimum (8 GB pour entraÃ®nement)
- **Stockage** : 2 GB pour modÃ¨le + dÃ©pendances
- **OS** : Windows / Linux / macOS

### Dataset (pour entraÃ®nement)
- Structure : `data/tomato/{classe1, classe2, ...}`
- Format : JPG/PNG
- RÃ©solution : 224x224 minimum
- Volume : 500-1000 images par classe recommandÃ©

---

## ğŸš€ Installation

### 1ï¸âƒ£ Cloner le dÃ©pÃ´t

```bash
git clone https://github.com/doosr/ai-module.git
cd ai-module
```

### 2ï¸âƒ£ CrÃ©er un environnement virtuel

```bash
# CrÃ©er l'environnement
python -m venv venv

# Activer l'environnement
# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

### 3ï¸âƒ£ Installer les dÃ©pendances

```bash
pip install -r requirements.txt
```

**Fichier `requirements.txt`** :
```txt
flask==3.0.0
flask-cors==4.0.0
tensorflow-cpu==2.15.0
numpy==1.24.3
pillow==10.1.0
requests==2.31.0
gunicorn==21.2.0
```

### 4ï¸âƒ£ Configuration

CrÃ©er un fichier `.env` :

```env
BACKEND_URL=http://localhost:5000
BACKEND_API_KEY=your-secret-key-changez-moi
SEND_TO_BACKEND=true
MODEL_PATH=models/tomato_disease_model.h5
DEBUG=false
```

---

## ğŸ“ Structure du Projet

```
ai-module/
â”œâ”€â”€ app.py                          # API Flask principale
â”œâ”€â”€ train.py                        # Script d'entraÃ®nement (optionnel)
â”œâ”€â”€ requirements.txt                # DÃ©pendances Python
â”œâ”€â”€ Procfile                        # Configuration Render/Heroku
â”œâ”€â”€ runtime.txt                     # Version Python
â”œâ”€â”€ .env                            # Variables d'environnement
â”œâ”€â”€ .gitignore                      
â”œâ”€â”€ README.md                       
â”‚
â”œâ”€â”€ models/
â”‚   â””â”€â”€ tomato_disease_model.h5     # ModÃ¨le entraÃ®nÃ© (85 MB)
â”‚
â””â”€â”€ data/                           # Dataset (optionnel, pour entraÃ®nement)
    â””â”€â”€ tomato/
        â”œâ”€â”€ Tomato_bacterial_spot/
        â”œâ”€â”€ Tomato_early_blight/
        â”œâ”€â”€ Tomato_healthy/
        â”œâ”€â”€ Tomato_late_blight/
        â”œâ”€â”€ Tomato_leaf_mold/
        â”œâ”€â”€ Tomato_septoria_leaf_spot/
        â”œâ”€â”€ Tomato_spider_mites_two-spotted_spider_mite/
        â”œâ”€â”€ Tomato_target_spot/
        â”œâ”€â”€ Tomato_mosaic_virus/
        â””â”€â”€ Tomato_yellow_leaf_curl_virus/
```

---

## ğŸ§  EntraÃ®nement du ModÃ¨le

### Option 1 : Utiliser le modÃ¨le prÃ©-entraÃ®nÃ©

Le modÃ¨le `tomato_disease_model.h5` est dÃ©jÃ  fourni dans le dossier `models/`.

### Option 2 : EntraÃ®ner votre propre modÃ¨le

```bash
# 1. PrÃ©parer le dataset dans data/tomato/
# 2. Lancer l'entraÃ®nement
python train.py

# Sortie attendue :
# ğŸš€ DÃ‰BUT ENTRAÃNEMENT MODÃˆLE TOMATE
# ğŸ“Š PrÃ©cision finale (val): 92.34%
# ğŸ’¾ ModÃ¨le sauvegardÃ©: models/tomato_disease_model.h5
```

**ParamÃ¨tres d'entraÃ®nement** :
- Architecture : MobileNetV2 + Dense layers
- Optimiseur : Adam (lr=0.001)
- Epochs : 50 (avec early stopping)
- Batch size : 32
- Augmentation : Rotation, flip, zoom, brightness

---

## ğŸŒ API Flask

### DÃ©marrage du serveur

```bash
# DÃ©veloppement local
python app.py

# Production avec Gunicorn (Linux)
gunicorn app:app --bind 0.0.0.0:5001 --workers 1 --timeout 300
```

**Sortie attendue** :
```
============================================================
ğŸ¤– Service IA - DÃ©tection Maladies des Tomates
============================================================
ğŸ“ Port: 5001
ğŸ”— Backend: http://localhost:5000
ğŸ“¦ ModÃ¨le: âœ… ChargÃ©
ğŸ“¤ Envoi backend: âœ… ActivÃ©
ğŸŒ± Classes supportÃ©es: 10
============================================================
```

### Routes disponibles

| MÃ©thode | Route | Description |
|---------|-------|-------------|
| `GET` | `/health` | Ã‰tat du service |
| `POST` | `/predict` | Analyser une image |
| `POST` | `/predict-batch` | Analyser plusieurs images |
| `GET` | `/stats` | Statistiques du modÃ¨le |
| `POST` | `/reload-model` | Recharger le modÃ¨le |
| `GET` | `/test-backend` | Tester connexion backend |

### ğŸ“¸ Exemple : Analyser une image

```bash
curl -X POST http://localhost:5001/predict \
  -F "image=@tomato_leaf.jpg" \
  -F "capteurId=esp32_001" \
  -F "userId=user_123"
```

**RÃ©ponse** :
```json
{
  "success": true,
  "prediction": "Tomato_early_blight",
  "predictionFr": "Mildiou prÃ©coce",
  "confidence": 0.9234,
  "diseaseDetected": true,
  "severity": "high",
  "shouldWater": true,
  "recommendations": [
    "Retirer les feuilles touchÃ©es",
    "Traiter avec fongicide prÃ©ventif",
    "AmÃ©liorer la circulation d'air",
    "Pailler le sol pour Ã©viter les Ã©claboussures"
  ],
  "timestamp": "2025-11-22T14:23:45.123456",
  "modelUsed": "tomato_disease_model",
  "backend_sent": true
}
```

---

## ğŸ¯ Classes DÃ©tectÃ©es

| # | Classe | Nom FranÃ§ais | SÃ©vÃ©ritÃ© | Arrosage |
|---|--------|--------------|----------|----------|
| 1 | `Tomato_healthy` | Sain | âœ… Aucune | âœ… Requis |
| 2 | `Tomato_bacterial_spot` | Tache bactÃ©rienne | ğŸ”´ Haute | âœ… Requis |
| 3 | `Tomato_early_blight` | Mildiou prÃ©coce | ğŸŸ  Moyenne | âœ… Requis |
| 4 | `Tomato_late_blight` | Mildiou tardif | ğŸ”´ Haute | âœ… Requis |
| 5 | `Tomato_leaf_mold` | Moisissure feuilles | ğŸŸ  Moyenne | âŒ Non |
| 6 | `Tomato_septoria_leaf_spot` | Tache septorienne | ğŸŸ  Moyenne | âŒ Non |
| 7 | `Tomato_spider_mites` | Acariens | ğŸŸ¡ Faible | âŒ Non |
| 8 | `Tomato_target_spot` | Tache cible | ğŸŸ  Moyenne | âŒ Non |
| 9 | `Tomato_mosaic_virus` | Virus mosaÃ¯que | ğŸ”´ Haute | âŒ Non |
| 10 | `Tomato_yellow_leaf_curl_virus` | Virus enroulement | ğŸ”´ Haute | âŒ Non |

### Exemple de recommandations

**Tomato Early Blight (Mildiou prÃ©coce)** :
- Retirer les feuilles touchÃ©es (partir du bas)
- Traiter avec fongicide prÃ©ventif (chlorothalonil)
- AmÃ©liorer la circulation d'air entre les plants
- Pailler le sol pour Ã©viter les Ã©claboussures
- Arroser Ã  la base des plants uniquement

---

## ğŸš€ DÃ©ploiement

### DÃ©ploiement sur Render.com

1. **Push sur GitHub** :
```bash
git add .
git commit -m "Deploy to Render"
git push origin main
```

2. **Configuration Render** :
   - New Web Service
   - Connect repository : `https://github.com/doosr/ai-module`
   - Build Command : `pip install -r requirements.txt`
   - Start Command : `gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --timeout 300`

3. **Variables d'environnement** :
```
BACKEND_URL=https://votre-backend.onrender.com
BACKEND_API_KEY=votre-cle-secrete
SEND_TO_BACKEND=true
MODEL_PATH=models/tomato_disease_model.h5
PYTHON_VERSION=3.11.0
```

4. **DÃ©ployer** â†’ Attendre 5-10 minutes

**URL finale** : `https://plant-disease-ai.onrender.com`

---

## ğŸ’» Utilisation

### Depuis ESP32-CAM

```cpp
#include <HTTPClient.h>

const char* serverUrl = "https://plant-disease-ai.onrender.com/predict";

void sendImage() {
  HTTPClient http;
  http.begin(serverUrl);
  http.addHeader("Content-Type", "multipart/form-data");
  
  // Ajouter image + capteurId + userId
  int httpCode = http.POST(imageData);
  
  if (httpCode == 200) {
    String response = http.getString();
    // Parser JSON et afficher rÃ©sultats
  }
  
  http.end();
}
```

### Depuis Python

```python
import requests

url = "http://localhost:5001/predict"
files = {"image": open("tomato_leaf.jpg", "rb")}
data = {
    "capteurId": "sensor_001",
    "userId": "user_123"
}

response = requests.post(url, files=files, data=data)
result = response.json()

print(f"Maladie : {result['predictionFr']}")
print(f"Confiance : {result['confidence']*100:.1f}%")
print(f"Recommandations : {result['recommendations']}")
```

### Depuis JavaScript

```javascript
const formData = new FormData();
formData.append('image', fileInput.files[0]);
formData.append('capteurId', 'web_upload');
formData.append('userId', 'user_123');

const response = await fetch('http://localhost:5001/predict', {
  method: 'POST',
  body: formData
});

const result = await response.json();
console.log(result);
```

---

## ğŸ§ª Tests

### Test health check

```bash
curl http://localhost:5001/health
```

### Test prÃ©diction

```bash
curl -X POST http://localhost:5001/predict \
  -F "image=@test_images/tomato_healthy.jpg" \
  -F "capteurId=test_sensor"
```

### Test batch

```bash
curl -X POST http://localhost:5001/predict-batch \
  -F "images=@image1.jpg" \
  -F "images=@image2.jpg" \
  -F "images=@image3.jpg"
```

---

## ğŸ”§ Troubleshooting

### Le modÃ¨le ne se charge pas

**Erreur** : `Model file not found`

**Solution** :
```bash
# VÃ©rifier que le modÃ¨le existe
ls -lh models/tomato_disease_model.h5

# VÃ©rifier la variable d'environnement
echo $MODEL_PATH

# Si absent, tÃ©lÃ©charger depuis Google Drive ou rÃ©entraÃ®ner
```

### Erreur "Out of Memory"

**Solution** : Utiliser `tensorflow-cpu` au lieu de `tensorflow`
```bash
pip uninstall tensorflow
pip install tensorflow-cpu==2.15.0
```

### Timeout lors de prÃ©dictions

**Solution** : Augmenter le timeout Gunicorn
```bash
gunicorn app:app --timeout 300
```

### Backend non joignable

**Solution** : VÃ©rifier la variable `BACKEND_URL`
```bash
curl http://localhost:5001/test-backend
```

---

## ğŸ¤ Contribution

Les contributions sont les bienvenues ! Voici comment contribuer :

1. Fork le projet
2. CrÃ©er une branche (`git checkout -b feature/AmazingFeature`)
3. Commit les changements (`git commit -m 'Add AmazingFeature'`)
4. Push vers la branche (`git push origin feature/AmazingFeature`)
5. Ouvrir une Pull Request

---

## ğŸ“Š MÃ©triques du ModÃ¨le

- **PrÃ©cision (validation)** : 92.34%
- **PrÃ©cision (entraÃ®nement)** : 95.67%
- **Taille du modÃ¨le** : 85 MB
- **Temps d'infÃ©rence** : ~200ms (CPU)
- **Classes supportÃ©es** : 10
- **Dataset** : PlantVillage (10,000+ images)

---

## ğŸ“ Sources & RÃ©fÃ©rences

- **Dataset** : [PlantVillage Dataset](https://www.kaggle.com/datasets/emmarex/plantdisease)
- **Architecture** : [MobileNetV2 Paper](https://arxiv.org/abs/1801.04381)
- **TensorFlow** : [tensorflow.org](https://www.tensorflow.org/)
- **Flask** : [flask.palletsprojects.com](https://flask.palletsprojects.com/)

---

## ğŸ“„ Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de dÃ©tails.

---

## ğŸ‘¥ Auteurs

- **Votre Nom** - [GitHub](https://github.com/doosr)

---

## ğŸ™ Remerciements

- PlantVillage pour le dataset
- TensorFlow team pour MobileNetV2
- CommunautÃ© open-source

---

## ğŸ“ Support

Pour toute question ou problÃ¨me :
- ğŸ› [Ouvrir une issue](https://github.com/doosr/ai-module/issues)
- ğŸ“§ Email : votre.email@example.com
- ğŸ’¬ Discord : [Serveur Discord](https://discord.gg/...)

---

<div align="center">

**â­ N'oubliez pas de star le projet si vous le trouvez utile ! â­**

Made with â¤ï¸ by [doosr](https://github.com/doosr)

</div>