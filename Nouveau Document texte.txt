#include "esp_camera.h"
#include <WiFi.h>
#include <HTTPClient.h>
#include <DHT.h>
#include "FS.h"
#include "SD_MMC.h"
#include <WebServer.h>
#include <Preferences.h>
#include <DNSServer.h>

// === CONFIG WI-FI ===
const char* ssid = "";
const char* password = "";

// === CONFIG BACKEND ===
const char* backendHost = "http://10.90.98.33";
const int backendPort = 5000;
const char* autoRegisterURL = "http://10.90.98.33:5000/api/capteur/auto-register";
const char* sensorDataURL = "http://10.90.98.33:5000/api/sensor/data";
const char* aiServiceURL = "http://10.90.98.33:5001/predict";

// === INFORMATIONS CAPTEUR ===
String capteurId = "";
String userId = "";
String macAddress = "";
String capteurNom = "Capteur Serre A";
String localisation = "Serre A - Zone Nord";

// === CAPTEURS ===
#define SOIL_MOISTURE_PIN 33
#define LDR_PIN 13
#define RELAY_PIN 2
#define DHT_PIN 15
#define DHT_TYPE DHT22
#define FLASH_LED_PIN 4

DHT dht(DHT_PIN, DHT_TYPE);

int seuilArrosage = 500;
bool arrosageAutomatique = true;

// === TIMERS ===
unsigned long lastSensorSend = 0;
unsigned long lastImageCapture = 0;
const unsigned long SENSOR_INTERVAL = 120000;   // 2 minutes
const unsigned long IMAGE_INTERVAL = 600000;    // 10 minutes

// === CONFIG CAMERA ===
#define PWDN_GPIO_NUM     32
#define RESET_GPIO_NUM    -1
#define XCLK_GPIO_NUM      0
#define SIOD_GPIO_NUM     26
#define SIOC_GPIO_NUM     27
#define Y9_GPIO_NUM       35
#define Y8_GPIO_NUM       34
#define Y7_GPIO_NUM       39
#define Y6_GPIO_NUM       36
#define Y5_GPIO_NUM       21
#define Y4_GPIO_NUM       19
#define Y3_GPIO_NUM       18
#define Y2_GPIO_NUM        5
#define VSYNC_GPIO_NUM    25
#define HREF_GPIO_NUM     23
#define PCLK_GPIO_NUM     22

int imageCount = 0;

// === SERVEUR WEB ===
WebServer server(80);
DNSServer dnsServer;
Preferences preferences;
bool wifiConfigMode = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE WEB DE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void handleRoot() {
  String html = "<!DOCTYPE html><html lang='fr'><head>";
  html += "<meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<title>Configuration WiFi - SmartPlant</title>";
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;";
  html += "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
  html += "min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }";
  html += ".container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);";
  html += "max-width: 500px; width: 100%; padding: 40px; }";
  html += ".header { text-align: center; margin-bottom: 30px; }";
  html += ".icon { font-size: 60px; margin-bottom: 15px; }";
  html += ".header h1 { color: #667eea; font-size: 28px; margin-bottom: 10px; font-weight: 700; }";
  html += ".header p { color: #666; font-size: 14px; }";
  html += ".info-box { background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);";
  html += "border-left: 4px solid #667eea; padding: 15px; border-radius: 10px; margin-bottom: 25px; }";
  html += ".info-box p { color: #555; font-size: 13px; line-height: 1.6; }";
  html += ".form-group { margin-bottom: 25px; }";
  html += "label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 14px; }";
  html += "input[type='text'], input[type='password'] { width: 100%; padding: 14px 16px;";
  html += "border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: all 0.3s; }";
  html += "input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102,126,234,0.1); }";
  html += ".btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);";
  html += "color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600;";
  html += "cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }";
  html += ".btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.5); }";
  html += ".scan-btn { width: 100%; padding: 12px; background: white; color: #667eea;";
  html += "border: 2px solid #667eea; border-radius: 10px; font-size: 14px; font-weight: 600;";
  html += "cursor: pointer; margin-bottom: 20px; }";
  html += ".networks-list { max-height: 200px; overflow-y: auto; border: 2px solid #e0e0e0;";
  html += "border-radius: 10px; margin-bottom: 20px; }";
  html += ".network-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }";
  html += ".network-item:hover { background: #f8f9ff; }";
  html += ".footer { text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; }";
  html += ".footer p { color: #999; font-size: 12px; }";
  html += ".mac-address { background: #f5f5f5; padding: 8px 12px; border-radius: 6px;";
  html += "font-family: 'Courier New', monospace; font-size: 11px; color: #666; margin-top: 8px; }";
  html += "</style></head><body>";
  html += "<div class='container'>";
  html += "<div class='header'><div class='icon'>ğŸŒ±</div>";
  html += "<h1>SmartPlant ESP32-CAM</h1><p>Configuration WiFi</p></div>";
  html += "<div class='info-box'><p>ğŸ“¡ Connectez votre ESP32-CAM Ã  votre rÃ©seau WiFi.</p></div>";
  html += "<button class='scan-btn' onclick='scanNetworks()'>ğŸ” Scanner les rÃ©seaux WiFi</button>";
  html += "<div id='networks-container'></div>";
  html += "<form action='/save' method='POST'>";
  html += "<div class='form-group'><label for='ssid'>ğŸ” Nom du rÃ©seau (SSID)</label>";
  html += "<input type='text' id='ssid' name='ssid' placeholder='Mon_Wifi' required></div>";
  html += "<div class='form-group'><label for='password'>ğŸ”‘ Mot de passe WiFi</label>";
  html += "<input type='password' id='password' name='password' placeholder='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' required></div>";
  html += "<button type='submit' class='btn'>âœ¨ Enregistrer et Connecter</button></form>";
  html += "<div class='footer'><p>Adresse MAC</p><div class='mac-address'>" + macAddress + "</div></div></div>";
  html += "<script>";
  html += "function scanNetworks(){";
  html += "var c=document.getElementById('networks-container');";
  html += "var b=document.querySelector('.scan-btn');";
  html += "b.disabled=true;b.textContent='â³ Scan...';";
  html += "c.innerHTML='<div style=\"padding:20px;text-align:center;color:#667eea\">ğŸ” Recherche...</div>';";
  html += "fetch('/scan').then(r=>r.json()).then(d=>{";
  html += "b.disabled=false;b.textContent='ğŸ” Scanner les rÃ©seaux WiFi';";
  html += "if(d.networks&&d.networks.length>0){";
  html += "var h='<div class=\"networks-list\">';";
  html += "d.networks.forEach(n=>{";
  html += "var s=n.rssi>-50?'ğŸ“¶ Excellent':n.rssi>-70?'ğŸ“¶ Bon':n.rssi>-80?'ğŸ“¶ Moyen':'ğŸ“¶ Faible';";
  html += "h+='<div class=\"network-item\" onclick=\"selectNetwork(\\''+n.ssid+'\\')\">';";
  html += "h+='<span>'+n.ssid+'</span> <span style=\"float:right;color:#667eea;font-size:12px\">'+s+'</span></div>';";
  html += "});h+='</div>';c.innerHTML=h;}";
  html += "else{c.innerHTML='<div class=\"info-box\"><p>Aucun rÃ©seau trouvÃ©.</p></div>';}";
  html += "}).catch(e=>{b.disabled=false;b.textContent='ğŸ” Scanner';";
  html += "c.innerHTML='<div class=\"info-box\"><p>âŒ Erreur scan.</p></div>';});}";
  html += "function selectNetwork(s){document.getElementById('ssid').value=s;";
  html += "document.getElementById('password').focus();}";
  html += "</script></body></html>";
  
  server.send(200, "text/html", html);
}

void handleScan() {
  Serial.println("ğŸ” Scan des rÃ©seaux WiFi...");
  int n = WiFi.scanNetworks();
  
  String json = "{\"networks\":[";
  if (n > 0) {
    for (int i = 0; i < n; i++) {
      if (i > 0) json += ",";
      json += "{\"ssid\":\"" + WiFi.SSID(i) + "\",\"rssi\":" + String(WiFi.RSSI(i)) + "}";
    }
  }
  json += "]}";
  
  server.send(200, "application/json", json);
  Serial.println("âœ… " + String(n) + " rÃ©seaux trouvÃ©s");
}

void handleSave() {
  String newSSID = server.arg("ssid");
  String newPassword = server.arg("password");
  
  Serial.println("\nğŸ’¾ Sauvegarde configuration...");
  Serial.println("   SSID: " + newSSID);
  
  preferences.begin("wifi", false);
  preferences.putString("ssid", newSSID);
  preferences.putString("password", newPassword);
  preferences.end();
  
  String html = "<!DOCTYPE html><html lang='fr'><head><meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<title>Configuration enregistrÃ©e</title><style>";
  html += "body{font-family:sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);";
  html += "min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}";
  html += ".container{background:white;border-radius:20px;padding:50px;text-align:center;max-width:450px;";
  html += "box-shadow:0 20px 60px rgba(0,0,0,0.3);}";
  html += ".success{color:#4CAF50;font-size:80px;margin-bottom:20px;}";
  html += "h1{color:#333;margin-bottom:15px;font-size:24px;}";
  html += "p{color:#666;line-height:1.6;margin-bottom:10px;}";
  html += ".ssid{color:#667eea;font-weight:600;}";
  html += ".countdown{margin-top:30px;padding:15px;background:#f0f4ff;border-radius:10px;color:#667eea;font-weight:600;}";
  html += ".spinner{border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;";
  html += "width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;}";
  html += "@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}";
  html += "</style></head><body><div class='container'>";
  html += "<div class='success'>âœ…</div><h1>Configuration enregistrÃ©e !</h1>";
  html += "<p>L'ESP32 va se connecter Ã </p><p class='ssid'>" + newSSID + "</p>";
  html += "<div class='spinner'></div>";
  html += "<div class='countdown'>â³ RedÃ©marrage dans <span id='timer'>3</span>s...</div></div>";
  html += "<script>let s=3;const t=setInterval(()=>{s--;document.getElementById('timer').textContent=s;";
  html += "if(s<=0){clearInterval(t);document.querySelector('.countdown').textContent='ğŸ”„ RedÃ©marrage...';}},1000);";
  html += "</script></body></html>";
  
  server.send(200, "text/html", html);
  
  Serial.println("âœ… Configuration sauvegardÃ©e !");
  Serial.println("ğŸ”„ RedÃ©marrage...");
  
  delay(3000);
  ESP.restart();
}

void handleCaptivePortal() {
  handleRoot();
}

void startConfigMode() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘     ğŸ“¡ MODE CONFIGURATION WiFi        â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  wifiConfigMode = true;
  
  String apName = "SmartPlant_" + macAddress.substring(9);
  apName.replace(":", "");
  
  WiFi.mode(WIFI_AP);
  WiFi.softAP(apName.c_str());
  
  IPAddress IP = WiFi.softAPIP();
  
  Serial.println("âœ… Point d'accÃ¨s crÃ©Ã© !");
  Serial.println("ğŸ“± Nom rÃ©seau: " + apName);
  Serial.println("ğŸŒ Adresse IP: " + IP.toString());
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘         ğŸ“‹ INSTRUCTIONS                â•‘");
  Serial.println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
  Serial.println("â•‘ 1. Connectez au WiFi: " + apName);
  Serial.println("â•‘ 2. Ouvrez navigateur                   â•‘");
  Serial.println("â•‘ 3. Allez sur: http://192.168.4.1      â•‘");
  Serial.println("â•‘ 4. Scannez et sÃ©lectionnez WiFi       â•‘");
  Serial.println("â•‘ 5. Entrez mot de passe                â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  dnsServer.start(53, "*", IP);
  
  server.on("/", handleRoot);
  server.on("/scan", handleScan);
  server.on("/save", HTTP_POST, handleSave);
  server.onNotFound(handleCaptivePortal);
  server.begin();
  
  Serial.println("ğŸš€ Serveur web dÃ©marrÃ© !");
  Serial.println("â³ En attente configuration...\n");
}

bool loadWiFiConfig(String &savedSSID, String &savedPassword) {
  preferences.begin("wifi", true);
  savedSSID = preferences.getString("ssid", "");
  savedPassword = preferences.getString("password", "");
  preferences.end();
  return (savedSSID.length() > 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-ENREGISTREMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool autoRegisterCapteur() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘    ğŸ”„ AUTO-ENREGISTREMENT CAPTEUR     â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("âŒ WiFi non connectÃ©");
    return false;
  }

  HTTPClient http;
  http.begin(autoRegisterURL);
  http.addHeader("Content-Type", "application/json");

  String jsonPayload = "{";
  jsonPayload += "\"macAddress\":\"" + macAddress + "\",";
  jsonPayload += "\"nom\":\"" + capteurNom + "\",";
  jsonPayload += "\"type\":\"ESP32-CAM\",";
  jsonPayload += "\"localisation\":\"" + localisation + "\"";
  jsonPayload += "}";

  Serial.println("ğŸ“¤ Envoi auto-enregistrement...");
  Serial.println(jsonPayload);

  int code = http.POST(jsonPayload);

  if (code <= 0) {
    Serial.printf("âŒ Erreur HTTP: %s\n", http.errorToString(code).c_str());
    http.end();
    return false;
  }

  String response = http.getString();
  Serial.printf("ğŸ“¥ RÃ©ponse (%d):\n", code);
  Serial.println(response);
  http.end();

  // Extraction capteurId
  int idStart = response.indexOf("\"capteurId\":\"");
  if (idStart != -1) {
    idStart += 13;
    int idEnd = response.indexOf("\"", idStart);
    capteurId = response.substring(idStart, idEnd);
  }

  // Extraction userId
  int userStart = response.indexOf("\"userId\":\"");
  if (userStart != -1) {
    userStart += 10;
    int userEnd = response.indexOf("\"", userStart);
    userId = response.substring(userStart, userEnd);
  }

  if (capteurId.length() == 0) {
    Serial.println("âŒ Aucun capteurId trouvÃ© !");
    return false;
  }

  Serial.println("\nğŸ‰ CAPTEUR ENREGISTRÃ‰ AVEC SUCCÃˆS !");
  Serial.println("ğŸ”‘ Capteur ID : " + capteurId);
  Serial.println("ğŸ§‘ User ID    : " + userId);

  // Sauvegarde en mÃ©moire
  preferences.begin("capteur", false);  
  preferences.putString("capteurId", capteurId);
  preferences.putString("userId", userId);
  preferences.end();

  Serial.println("\nğŸ’¾ EnregistrÃ© en mÃ©moire !");
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT SD CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bool initSDCard() {
  if(!SD_MMC.begin("/sdcard", true)) {
    Serial.println("âŒ Erreur SD");
    return false;
  }
  Serial.println("âœ… SD OK");
  if(!SD_MMC.exists("/images")) {
    SD_MMC.mkdir("/images");
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPTURE ET ENVOI IMAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void captureAndSendImage() {
  Serial.println("\nğŸ“¸ Capture image...");
  digitalWrite(FLASH_LED_PIN, HIGH);
  Serial.println("ğŸ’¡ LED allumÃ©e");
  delay(100);
  
  camera_fb_t * fb = esp_camera_fb_get();
  digitalWrite(FLASH_LED_PIN, LOW);
  Serial.println("ğŸ’¡ LED Ã©teinte");
  
  if(!fb) {
    Serial.println("âŒ Erreur capture");
    return;
  }

  imageCount++;
  String filename = "/images/plant_" + String(imageCount) + ".jpg";
  File file = SD_MMC.open(filename.c_str(), FILE_WRITE);
  if(file) {
    file.write(fb->buf, fb->len);
    file.close();
    Serial.printf("âœ… SauvegardÃ© SD: %s\n", filename.c_str());
  }

  // Envoi au service IA
  if(WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    
    http.begin(aiServiceURL);
    http.setTimeout(30000);
    
    String boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW";
    http.addHeader("Content-Type", "multipart/form-data; boundary=" + boundary);

    String head = "--" + boundary + "\r\n";

    // Envoyer capteurId
    if(capteurId.length() > 0) {
      head += "Content-Disposition: form-data; name=\"capteurId\"\r\n\r\n";
      head += capteurId + "\r\n--" + boundary + "\r\n";
    }

    // Envoyer userId
    if(userId.length() > 0) {
      head += "Content-Disposition: form-data; name=\"userId\"\r\n\r\n";
      head += userId + "\r\n--" + boundary + "\r\n";
    }

    // Image
    head += "Content-Disposition: form-data; name=\"image\"; filename=\"plant.jpg\"\r\n";
    head += "Content-Type: image/jpeg\r\n\r\n";

    String tail = "\r\n--" + boundary + "--\r\n";
    uint32_t totalLen = head.length() + fb->len + tail.length();

    uint8_t *fullBuffer = (uint8_t *)malloc(totalLen);
    
    if(fullBuffer) {
      uint32_t offset = 0;
      
      memcpy(fullBuffer + offset, head.c_str(), head.length());
      offset += head.length();
      
      memcpy(fullBuffer + offset, fb->buf, fb->len);
      offset += fb->len;
      
      memcpy(fullBuffer + offset, tail.c_str(), tail.length());

      Serial.println("ğŸ“¤ Envoi image au service IA...");
      Serial.println("   URL: " + String(aiServiceURL));
      Serial.println("   CapteurId: " + capteurId);
      Serial.println("   UserId: " + userId);
      
      int httpResponseCode = http.POST(fullBuffer, totalLen);
      free(fullBuffer);

      if(httpResponseCode > 0) {
        Serial.printf("âœ… RÃ©ponse IA! Code %d\n", httpResponseCode);
        
        String response = http.getString();
        Serial.println("\nğŸ¤– RÃ©sultat analyse:");
        Serial.println(response);
        
        int maladieStart = response.indexOf("\"maladie\":\"") + 11;
        int maladieEnd = response.indexOf("\"", maladieStart);
        if(maladieStart > 10 && maladieEnd > maladieStart) {
          String maladie = response.substring(maladieStart, maladieEnd);
          Serial.println("   Maladie: " + maladie);
        }
        
        int confianceStart = response.indexOf("\"confiance\":") + 12;
        int confianceEnd = response.indexOf(",", confianceStart);
        if(confianceStart > 11) {
          String confiance = response.substring(confianceStart, confianceEnd);
          Serial.println("   Confiance: " + String(atof(confiance.c_str()) * 100) + "%");
        }
        
      } else {
        Serial.printf("âŒ Erreur IA: %s\n", http.errorToString(httpResponseCode).c_str());
      }
      http.end();
    }
  } else {
    Serial.println("âŒ WiFi dÃ©connectÃ©");
  }
  
  esp_camera_fb_return(fb);
  Serial.println("âœ¨ Analyse terminÃ©e\n");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENVOI DONNÃ‰ES CAPTEURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void sendSensorData() {
  Serial.println("\nâ° Envoi capteurs...");
  
  int soilMoisture = analogRead(SOIL_MOISTURE_PIN);
  int luminosity = analogRead(LDR_PIN);
  float temperature = dht.readTemperature();
  float humidityAir = dht.readHumidity();

  if (isnan(temperature) || isnan(humidityAir)) {
    Serial.println("âŒ Erreur DHT22");
    return;
  }

  if(arrosageAutomatique) {
    digitalWrite(RELAY_PIN, soilMoisture < seuilArrosage ? HIGH : LOW);
  }

  String jsonPayload = "{";
  jsonPayload += "\"humiditeSol\":" + String(soilMoisture) + ",";
  jsonPayload += "\"luminosite\":" + String(luminosity) + ",";
  jsonPayload += "\"temperatureAir\":" + String(temperature, 2) + ",";
  jsonPayload += "\"humiditeAir\":" + String(humidityAir, 2) + ",";
  jsonPayload += "\"etatPompe\":" + String(digitalRead(RELAY_PIN));
  if(capteurId.length() > 0) {
    jsonPayload += ",\"capteurId\":\"" + capteurId + "\"";
  }
  jsonPayload += "}";

  HTTPClient http;
  http.begin(sensorDataURL);
  http.addHeader("Content-Type", "application/json");

  int httpResponseCode = http.POST(jsonPayload);

  if(httpResponseCode > 0) {
    Serial.printf("âœ… EnvoyÃ© (Code %d)\n", httpResponseCode);
  } else {
    Serial.printf("âŒ Erreur: %s\n", http.errorToString(httpResponseCode).c_str());
  }

  http.end();

  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.printf("â•‘ ğŸŒ± HumiditÃ© sol : %-18d â•‘\n", soilMoisture);
  Serial.printf("â•‘ â˜€ï¸  LuminositÃ©  : %-18d â•‘\n", luminosity);
  Serial.printf("â•‘ ğŸŒ¡ï¸  TempÃ©rature : %-16.2fÂ°C â•‘\n", temperature);
  Serial.printf("â•‘ ğŸ’§ HumiditÃ© air : %-16.2f%% â•‘\n", humidityAir);
  Serial.printf("â•‘ ğŸ’¦ Pompe       : %-18s â•‘\n", digitalRead(RELAY_PIN) ? "ON" : "OFF");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

void displayNextSendTime() {
  unsigned long currentMillis = millis();
  unsigned long nextSensor = lastSensorSend + SENSOR_INTERVAL;
  unsigned long nextImage = lastImageCapture + IMAGE_INTERVAL;
  
  if(currentMillis < nextSensor) {
    Serial.printf("â±ï¸  Prochain envoi capteurs: %lus\n", (nextSensor - currentMillis) / 1000);
  }
  if(currentMillis < nextImage) {
    Serial.printf("ğŸ“¸ Prochaine photo: %lus\n", (nextImage - currentMillis) / 1000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  // ğŸ”¥ EFFACER MÃ‰MOIRE (Ã  retirer aprÃ¨s premier test rÃ©ussi)
  preferences.begin("capteur", false);
  preferences.clear();
  preferences.end();
  Serial.println("ğŸ—‘ï¸ MÃ©moire capteur effacÃ©e - rÃ©enregistrement forcÃ©");
  
  Serial.println("\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘     ğŸŒ± SmartPlant ESP32-CAM ğŸŒ±        â•‘");
  Serial.println("â•‘  SystÃ¨me d'irrigation intelligent     â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  pinMode(SOIL_MOISTURE_PIN, INPUT);
  pinMode(LDR_PIN, INPUT);
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW);
  pinMode(FLASH_LED_PIN, OUTPUT);  // Initialiser la LED flash

  dht.begin();

  WiFi.mode(WIFI_STA);
WiFi.disconnect(true);       // IMPORTANT : reset WiFi pour obtenir vraie MAC
delay(200);
WiFi.begin();                // Initialisation sans connexion
delay(200);

macAddress = WiFi.macAddress();

Serial.println("ğŸ“Ÿ MAC rÃ©elle: " + macAddress);

  String savedSSID = "";
  String savedPassword = "";
  bool hasConfig = loadWiFiConfig(savedSSID, savedPassword);


 
if (!hasConfig) {
    Serial.println("âš ï¸  Aucune configuration WiFi trouvÃ©e !");
    Serial.println("ğŸ”„ DÃ©marrage en mode configuration...\n");
    startConfigMode();
    while(wifiConfigMode) {
      dnsServer.processNextRequest();
      server.handleClient();
      delay(10);
    }
    return;
  }
  
  String wifiSSID = (String(ssid).length() > 0) ? String(ssid) : savedSSID;
  String wifiPassword = (String(password).length() > 0) ? String(password) : savedPassword;

  Serial.print("\nğŸ“¡ Connexion Ã : " + wifiSSID);
  WiFi.begin(wifiSSID.c_str(), wifiPassword.c_str());
  
  int attempts = 0;
  while(WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if(WiFi.status() == WL_CONNECTED) {
    Serial.println("\nâœ… WiFi connectÃ© !");
    Serial.println("ğŸ“ IP: " + WiFi.localIP().toString());
    
    delay(2000);
    autoRegisterCapteur();

    if (capteurId.length() > 0) {
      Serial.println("ğŸ” CapteurId dÃ©jÃ  enregistrÃ© : " + capteurId);
    } else {
      Serial.println("âš ï¸ Aucun capteurId trouvÃ©. Auto-enregistrement...");
    }

  } else {
    Serial.println("\nâŒ Ã‰chec WiFi");
    Serial.println("ğŸ”„ RedÃ©marrage en mode config...");
    
    preferences.begin("wifi", false);
    preferences.clear();
    preferences.end();
    
    delay(2000);
    ESP.restart();
    return;
  }

  Serial.println("\nğŸ’¾ Init SD...");
  initSDCard();

  Serial.println("\nğŸ“· Init camÃ©ra...");
  camera_config_t config;
  config.ledc_channel = LEDC_CHANNEL_0;
  config.ledc_timer = LEDC_TIMER_0;
  config.pin_d0 = Y2_GPIO_NUM;
  config.pin_d1 = Y3_GPIO_NUM;
  config.pin_d2 = Y4_GPIO_NUM;
  config.pin_d3 = Y5_GPIO_NUM;
  config.pin_d4 = Y6_GPIO_NUM;
  config.pin_d5 = Y7_GPIO_NUM;
  config.pin_d6 = Y8_GPIO_NUM;
  config.pin_d7 = Y9_GPIO_NUM;
  config.pin_xclk = XCLK_GPIO_NUM;
  config.pin_pclk = PCLK_GPIO_NUM;
  config.pin_vsync = VSYNC_GPIO_NUM;
  config.pin_href = HREF_GPIO_NUM;
  config.pin_sccb_sda = SIOD_GPIO_NUM;
  config.pin_sccb_scl = SIOC_GPIO_NUM;
  config.pin_pwdn = PWDN_GPIO_NUM;
  config.pin_reset = RESET_GPIO_NUM;
  config.xclk_freq_hz = 20000000;
  config.pixel_format = PIXFORMAT_JPEG;
  config.frame_size = FRAMESIZE_SVGA;
  config.jpeg_quality = 12;
  config.fb_count = 1;

  esp_err_t err = esp_camera_init(&config);
  if (err == ESP_OK) {
    Serial.println("âœ… CamÃ©ra OK");
  } else {
    Serial.printf("âŒ Erreur camÃ©ra: 0x%x\n", err);
  }

  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘        âœ¨ SYSTÃˆME PRÃŠT âœ¨             â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  delay(2000);
  Serial.println("ğŸš€ Premier envoi...\n");
  sendSensorData();
  lastSensorSend = millis();
  
  delay(2000);
  captureAndSendImage();
  lastImageCapture = millis();
  
  Serial.println("\nğŸ”„ Boucle dÃ©marrÃ©e...\n");
}

// === LOOP ===
void loop() {
  if(wifiConfigMode) {
    dnsServer.processNextRequest();
    server.handleClient();
    return;
  }
  
  unsigned long currentMillis = millis();

  if (currentMillis - lastSensorSend >= SENSOR_INTERVAL) {
    sendSensorData();
    lastSensorSend = currentMillis;
  }

  if (currentMillis - lastImageCapture >= IMAGE_INTERVAL) {
    captureAndSendImage();
    lastImageCapture = currentMillis;
  }

  static unsigned long lastDisplay = 0;
  if(currentMillis - lastDisplay >= 30000) {
    displayNextSendTime();
    lastDisplay = currentMillis;
  }

  delay(1000);
}
